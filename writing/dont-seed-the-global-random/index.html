<!DOCTYPE html>
<html lang="en">
<head>
    <!-- HTTPS redirect for github pages -->
    <script type="text/javascript">
        var host = 'nishanths.github.io';
        if ((host === window.location.host) && (window.location.protocol === 'http:')) {
            window.location.protocol = 'https'; // without ':' for firefox compatibility
        }
    </script>
    <!-- styles -->
    <link rel="stylesheet" href=" /css/main.css ">
    <link href='https://fonts.googleapis.com/css?family=Inconsolata:400,700|Lato:400,400italic,700,700italic' rel='stylesheet' type='text/css'>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta content="Nishanth Shanmugham: web developer" property="og:title">
    <meta content="Nishanth Shanmugham: web developer" property="twitter:title">
    <meta content="website" property="og:type">
    <meta content="Nishanth Shanmugham" property="og:site_name">
    <meta property="fb:admins" content="1103227056" />
    <!-- title and desc -->
    <title>Don't seed the global random in your package | Nishanth Shanmugham</title>
    <meta name="description" content="Go has a global random generator that is used when you call functions in the math/rand package.">

    <link rel="canonical" href="https://nishanths.github.io/writing/dont-seed-the-global-random/">
    <link rel="alternate" type="application/rss+xml" title="Nishanth Shanmugham" href="https://nishanths.github.io/feed.xml">
</head>

<body class="width mx-auto px3 my4">
    <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    <h1 class="top-subtitle">
        <a href="/writing/">Writing</a>
        <a href="/"><div class="dot"></div></a>
    </h1>
    <h1 class="title" itemprop="name headline"><a href="">Don't seed the global random in your package</a></h1>
    <div class="meta">
        <span class="h1" itemprop="author" itemscope itemtype="http://schema.org/Person">
            <a href="/"><span itemprop="name">Nishanth Shanmugham</span></a>
        </span>
        <time datetime="2016-02-27T07:43:39+00:00" itemprop="datePublished" title="It was a beautiful day!">
            27 Feb 2016
        </time>
    </div>
  </header>

  <div class="content" itemprop="articleBody">
    <p>Go has a global random generator that is used when you call functions in the <code class="highlighter-rouge">math/rand</code> package.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">number</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">rand</span><span class="o">.</span><span class="n">Int</span><span class="p">()</span><span class="x">
</span></code></pre>
</div>

<p>As of <code class="highlighter-rouge">go1.6</code>, it is <a href="https://golang.org/src/math/rand/rand.go?#L178">seeded to the same value at the start of every program</a>, which means that a deterministic sequence of numbers is returned every time the program is run.</p>

<!--more-->

<p>The <code class="highlighter-rouge">Seed</code> function allows you to introduce randomness by seeding the underlying source.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">rand</span><span class="o">.</span><span class="n">Seed</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span><span class="o">.</span><span class="n">UnixNano</span><span class="p">())</span><span class="x">
</span></code></pre>
</div>

<p>However, calling <code class="highlighter-rouge">rand.Seed()</code> modifies the global random that other packages or client programs where your package is being imported into also have access to. <strong>This could lead to confusion and errors, especially if the client program also seeds the global random in a different manner.</strong></p>

<p>So, if you are making a package that will be used by others, consider creating your own private random number generator. Add a file <code class="highlighter-rouge">random.go</code> to your package:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">package</span><span class="x"> </span><span class="n">bar</span><span class="x">

</span><span class="k">import</span><span class="x"> </span><span class="p">(</span><span class="x">
	</span><span class="s">"math/rand"</span><span class="x">
	</span><span class="s">"sync"</span><span class="x">
	</span><span class="s">"time"</span><span class="x">
</span><span class="p">)</span><span class="x">

</span><span class="k">var</span><span class="x"> </span><span class="n">random</span><span class="x"> </span><span class="o">*</span><span class="n">rand</span><span class="o">.</span><span class="n">Rand</span><span class="x"> </span><span class="c">// your private random</span><span class="x">

</span><span class="k">func</span><span class="x"> </span><span class="n">init</span><span class="p">()</span><span class="x"> </span><span class="p">{</span><span class="x">
       </span><span class="n">random</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="n">rand</span><span class="o">.</span><span class="n">New</span><span class="p">(</span><span class="x">
		</span><span class="o">&amp;</span><span class="n">lockedRandSource</span><span class="p">{</span><span class="x">
			</span><span class="n">src</span><span class="o">:</span><span class="x"> </span><span class="n">rand</span><span class="o">.</span><span class="n">NewSource</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span><span class="o">.</span><span class="n">UnixNano</span><span class="p">()),</span><span class="x">
		</span><span class="p">},</span><span class="x">
	</span><span class="p">)</span><span class="x">
</span><span class="p">}</span><span class="x">

</span><span class="c">// locked to prevent concurrent use of the underlying source</span><span class="x">
</span><span class="k">type</span><span class="x"> </span><span class="n">lockedRandSource</span><span class="x"> </span><span class="k">struct</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="n">lock</span><span class="x"> </span><span class="n">sync</span><span class="o">.</span><span class="n">Mutex</span><span class="x"> </span><span class="c">// protects src</span><span class="x">
	</span><span class="n">src</span><span class="x">  </span><span class="n">rand</span><span class="o">.</span><span class="n">Source</span><span class="x">
</span><span class="p">}</span><span class="x">

</span><span class="c">// to satisfy rand.Source interface</span><span class="x">
</span><span class="k">func</span><span class="x"> </span><span class="p">(</span><span class="n">r</span><span class="x"> </span><span class="o">*</span><span class="n">lockedRandSource</span><span class="p">)</span><span class="x"> </span><span class="n">Int63</span><span class="p">()</span><span class="x"> </span><span class="kt">int64</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="n">r</span><span class="o">.</span><span class="n">lock</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span><span class="x">
	</span><span class="n">ret</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">r</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">Int63</span><span class="p">()</span><span class="x">
	</span><span class="n">r</span><span class="o">.</span><span class="n">lock</span><span class="o">.</span><span class="n">Unlock</span><span class="p">()</span><span class="x">
	</span><span class="k">return</span><span class="x"> </span><span class="n">ret</span><span class="x">
</span><span class="p">}</span><span class="x">

</span><span class="c">// to satisfy rand.Source interface</span><span class="x">
</span><span class="k">func</span><span class="x"> </span><span class="p">(</span><span class="n">r</span><span class="x"> </span><span class="o">*</span><span class="n">lockedRandSource</span><span class="p">)</span><span class="x"> </span><span class="n">Seed</span><span class="p">(</span><span class="n">seed</span><span class="x"> </span><span class="kt">int64</span><span class="p">)</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="n">r</span><span class="o">.</span><span class="n">lock</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span><span class="x">
	</span><span class="n">r</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">Seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span><span class="x">
	</span><span class="n">r</span><span class="o">.</span><span class="n">lock</span><span class="o">.</span><span class="n">Unlock</span><span class="p">()</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></code></pre>
</div>

<p>Now, use you can the variable <code class="highlighter-rouge">random</code> to generate random numbers for use in your package. This is the approach I use in <a href="https://github.com/nishanths/go-xkcd">go-xkcd</a>, an xkcd API client.</p>

<p>Let me know of your comments or other approaches on <a href="https://twitter.com/nshanmugham">twitter</a>.</p>

  </div>
</article>

    <script>
    (function() {
        (function(i, s, o, g, r, a, m) {
            i['GoogleAnalyticsObject'] = r;
            i[r] = i[r] || function() {
                (i[r].q = i[r].q || []).push(arguments)
            }, i[r].l = 1 * new Date();
            a = s.createElement(o),
                m = s.getElementsByTagName(o)[0];
            a.async = 1;
            a.src = g;
            m.parentNode.insertBefore(a, m)
        })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');

        var GOOGLE_ANALYTICS_TRACKING_ID = "UA-61427501-2";

        ga('create', GOOGLE_ANALYTICS_TRACKING_ID, 'auto');
        ga('send', 'pageview');
    })();
</script>

</body>
</html>
